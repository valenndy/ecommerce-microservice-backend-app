{{- if .Values.networkPolicy.enabled }}
# NetworkPolicy para permitir tráfico desde API Gateway a servicios de negocio
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: {{ include "ecommerce-microservices.fullname" . }}-allow-from-api-gateway
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "ecommerce-microservices.labels" . | nindent 4 }}
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app: api-gateway

---
# NetworkPolicy para permitir tráfico desde Ingress Controller
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: {{ include "ecommerce-microservices.fullname" . }}-allow-from-ingress
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "ecommerce-microservices.labels" . | nindent 4 }}
spec:
  podSelector:
    matchLabels:
      app: api-gateway
  policyTypes:
  - Ingress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          name: ingress-nginx

---
# NetworkPolicy para permitir comunicación entre servicios del mismo namespace
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: {{ include "ecommerce-microservices.fullname" . }}-allow-inter-service
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "ecommerce-microservices.labels" . | nindent 4 }}
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  ingress:
  - from:
    - podSelector: {}

---
# NetworkPolicy para user-service
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: {{ include "ecommerce-microservices.fullname" . }}-user-service
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "ecommerce-microservices.labels" . | nindent 4 }}
spec:
  podSelector:
    matchLabels:
      app: user-service
  policyTypes:
  - Ingress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app: api-gateway
    - podSelector:
        matchLabels:
          app: proxy-client
    - podSelector:
        matchLabels:
          app: order-service

---
# NetworkPolicy para product-service
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: {{ include "ecommerce-microservices.fullname" . }}-product-service
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "ecommerce-microservices.labels" . | nindent 4 }}
spec:
  podSelector:
    matchLabels:
      app: product-service
  policyTypes:
  - Ingress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app: api-gateway
    - podSelector:
        matchLabels:
          app: favourite-service
    - podSelector:
        matchLabels:
          app: order-service

---
# NetworkPolicy para order-service
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: {{ include "ecommerce-microservices.fullname" . }}-order-service
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "ecommerce-microservices.labels" . | nindent 4 }}
spec:
  podSelector:
    matchLabels:
      app: order-service
  policyTypes:
  - Ingress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app: api-gateway
    - podSelector:
        matchLabels:
          app: proxy-client

---
# NetworkPolicy para favourite-service
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: {{ include "ecommerce-microservices.fullname" . }}-favourite-service
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "ecommerce-microservices.labels" . | nindent 4 }}
spec:
  podSelector:
    matchLabels:
      app: favourite-service
  policyTypes:
  - Ingress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app: api-gateway
    - podSelector:
        matchLabels:
          app: proxy-client

---
# NetworkPolicy para payment-service
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: {{ include "ecommerce-microservices.fullname" . }}-payment-service
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "ecommerce-microservices.labels" . | nindent 4 }}
spec:
  podSelector:
    matchLabels:
      app: payment-service
  policyTypes:
  - Ingress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app: order-service

---
# NetworkPolicy para shipping-service
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: {{ include "ecommerce-microservices.fullname" . }}-shipping-service
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "ecommerce-microservices.labels" . | nindent 4 }}
spec:
  podSelector:
    matchLabels:
      app: shipping-service
  policyTypes:
  - Ingress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app: order-service

---
# NetworkPolicy para Service Discovery y Cloud Config
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: {{ include "ecommerce-microservices.fullname" . }}-infrastructure-services
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "ecommerce-microservices.labels" . | nindent 4 }}
spec:
  podSelector:
    matchExpressions:
    - key: app
      operator: In
      values: ["service-discovery", "cloud-config"]
  policyTypes:
  - Ingress
  ingress:
  - from:
    - podSelector: {}

{{- end }}
